---
title: "Reporte Técnico RUNT"

author:
- "**Karen Andrea Amaya**"
- "**Sebastián Restrepo Betancur**"
- "**María Del Pilar Mira Londoño**"
- "**María Isabel Plata**"
date: "Enero de 2022"
output: rmdformats::robobook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```

```{r warning=F, message=F, results='hide'}
library(tidyverse)
library(kableExtra)
require(gridExtra)
library(gamlss)
```

## Introducción

El presente trabajo busca predecir el número de vehículos registrados a diario en el sistema de tránsito nacional RUNT a través de un modelo estadístico. El Registro Único Nacional de Tránsito (RUNT) es un sistema de información en Colombia que permite "registrar y mantener actualizada, autorizada y validada la información de todo el sector de tránsito y transporte", por lo cual es de suma importancia para el sector público y de transporte tener un pronóstico que les permita impulsar diferentes políticas o planes de acción. Para dar solución a este problema se parte de la cantidad de vehículos registrados en el RUNT desde el 1 de enero del 2012 hasta el 31 de diciembre del 2017.

## Análisis descriptivo

El Año donde se registraron más vehículos fue el 2014, con aproximadamente 327957 registros. Por otro lado el año con menos registros fue el 2017 con aproximadamente 240378. Con un aparente comportamiento decreciente desde el año 2014 al 2017.

```{r out.width="60%"}
Anio= c("2012","2013","2014","2015","2016","2017")
Cantidad_registros= c(311920, 295803, 327957, 284916, 254893, 240378)

db=data.frame(Anio,Cantidad_registros)

gr4 <- ggplot(db, aes(x=Anio, y=Cantidad_registros, fill=Anio)) + geom_bar(stat="identity")+ labs(title="Cantidad de registros por Año")+
  theme (plot.title = element_text(family="Comic Sans MS",
                                   size=rel(1.5),  
                                   vjust=2,  
                                   face="bold", 
                                   color="black", 
                                   lineheight=1.0)) + 
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_brewer(palette = "Set3")+
  theme(axis.text.x = element_blank(), axis.ticks = element_blank(),axis.title = element_blank()) 
gr4
```

Por otro lado, realizando un análisis de meses, el mes de Diciembre es aquel con una cifra significativamente más alta que los demás meses, esto puede ser debido a que los vendedores tienen un margen de ventas por cumplir, lo que hace que diciembre se convierta en un mes muy recomendado por los expertos para comprar carro. Por otro lado, el mes con menos registros resultó ser el mes de Enero.

```{r out.width="60%"}
MES=c("January","February","March","April","May","June","July","August","September","October","November","December")
Cantidad_registro= c(115653, 132001, 140967,137742,141168, 133853,142714,144291,146002,146319,140249,194908)
dI= data.frame(MES,Cantidad_registro)

gr1 <- ggplot(dI,aes(x=MES, y=Cantidad_registro, fill=MES)) + geom_bar(stat="identity")+ labs(title="Cantidad de registros por mes")+coord_flip()+
  theme (plot.title = element_text(family="Comic Sans MS",
                                   size=rel(1.5),  
                                   vjust=2,  
                                   face="bold", 
                                   color="black", 
                                   lineheight=1.0)) + 
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_brewer(palette = "Set3")+
  theme(axis.text.x = element_blank(), axis.ticks = element_blank(),axis.title = element_blank(),legend.position="none") 
gr1

```

Resulta de interes conocer cómo varía el número de registros de acuerdo al día de la semana. Según el siguiente gráfico, todos los días tienen un comportamiento similar, a excepción de los días Sábado y Lunes donde hay considerablemente una cantidad menor, y el Domingo donde no se presta el servicio.

```{r out.width="60%"}
dia=c("Monday","Sunday","Saturday","Friday","Thursday","Tuesday","Wednesday")
Cantidad_vehiculos= c(208582,893,107857, 368495,361025,314588,354427)
ho=data.frame(dia,Cantidad_vehiculos)

gr0 <- ggplot(ho, aes(x=dia, y=Cantidad_vehiculos, fill=dia)) + geom_bar(stat="identity")+ labs(title="Cantidad de registros por dia de la semana")+coord_flip()+
  theme (plot.title = element_text(family="Comic Sans MS",
                                   size=rel(1.5),  
                                   vjust=2,  
                                   face="bold", 
                                   color="black", 
                                   lineheight=1.0)) + 
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_brewer(palette = "Set3")+
  theme(axis.text.x = element_blank(), axis.ticks = element_blank(),axis.title = element_blank(),legend.position="none") 
gr0
```

## Base de datos

La base de datos final está compuesta por las siguientes variables:

- **Unidades:** Cantidad de registros en en RUNT por fecha. Variable respuesta de tipo entero.
- **año:** Variable explicativa de tipo entero
- **mes:** Variable explicativa de tipo factor con 12 niveles
- **dia:** Día de tipo factor con 7 niveles
- **dia_num:** Número del día según el calendario, de tipo entero
- **holi_bin:** Variable de tipo factor con 2 niveles, 1 si es un festivo nacional y 0 en caso contrario
- **observance:** Fechas especiales no festivas en Colombia, con 29 niveles. Expresadas en tipo Dummy.
- **dolar:** Es la cantidad de pesos colombianos por un dólar de los Estados Unidos en las respectivas fechas.
-**quincena:** Son los días en que generalmente le pagan a un empleado en Colombia, los días 1 y 15 de cada mes.


```{r}
datos<-readRDS("Runt_app/BaseFinal.rds")
datos$Unidades<-as.integer(datos$Unidades)
datos%>%kbl() %>%  kable_styling(font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "300px")
```


Se dividen los datos en train con los años de 2012 a 2017 y se realiza test con los datos del primer semestre del 2018. A continuación se lista el nombre de los festivos nacionales y las fechas especiales no festivas respectivamente:  


```{r}
holid<-readRDS("Runt_app/national_holidays.rds")
data.frame("National Holidays"=unique(holid$name))%>%kbl() %>% kable_styling(font_size = 12) %>% kableExtra::scroll_box(width = "30%", height = "190px")
```

```{r}
special<-readRDS("Runt_app/special_dates.rds")
data.frame("Special dates"=unique(special$name)) %>% kbl() %>%  kable_styling(font_size = 12) %>% kableExtra::scroll_box(width = "30%", height = "190px")
```

```{r}
train<-filter(datos, year<= 2016)
test <-filter(datos, year > 2016 )
```

```{r}
# Modelo Lineal Basico
mod0 <- lm(Unidades ~. , data = train)
```

## Datos atípicos

```{r out.width="60%"}
P1 <- ggplot(train, aes(y=Unidades))+
  geom_boxplot(fill='#FFCCC1',alpha=0.7)+
  labs(title = 'Gráfico de cajas para la variable Unidad',
       x = 'Unidades', y='Número de registros diarios RUNT',
       color=NULL)

cooksd <- cooks.distance(mod0)
P2<- ggplot(train, aes(x=Unidades, y=cooksd)) + 
  geom_point(col='black', fill='blue', shape=21, alpha=0.5)+ geom_hline(yintercept = 4*mean(cooksd, na.rm=T), color = "red")+ ggtitle("Distancias de Cook (Modelo Lineal")

grid.arrange(P1, P2, ncol=2)
```

```{r}
influential <- na.omit(as.numeric(names(cooksd)[(cooksd > (4/nrow(train)))]))
train2 <- datos[-influential, ]
```



```{r}
# Modelos Sin Outliers
mod1 <- lm(Unidades ~. , data = train2)
```



```{r}
## Modelo Raiz
mod2 <- lm(sqrt(Unidades) ~. , data = train2)
#saveRDS(mod2, "Modelo.rds")
```



## Comparacion de modelos

Se hace uso de las siguientes medidas para comparar diferentes modelos:

$$
R_{p s e u d o}^{2}=1-\frac{\sum_{i=1}^{n}\left(y_{i}-\hat{y}_{i}\right)^{2}}{\sum_{i=1}^{n}\left(y_{i}-\bar{y}\right)^{2}}; \quad \quad \text { MSE }=\frac{1}{n} \sum\left(y_{n}-\overline{\mathrm{y}}\right)^{2}; \quad \quad A I C=2 k-2 \ln (L)
$$


### Medidas de entrenamiento

```{r}
metricas<- data.frame("Modelo"=c("Modelo0","Modelo1","Modelo2"),
                      "MSE"=c(mean(mod0$residuals^2),
                              mean(mod1$residuals^2),
                              mean((train2$Unidades - fitted(mod2)^2)^2)),
                      "R pseudo2"= c(summary(mod0)$r.squared,
                              summary(mod1)$r.squared,
                              summary(mod2)$r.squared),
                      "AIC"=c(AIC(mod0),
                              AIC(mod1),
                              AIC(mod2)))
metricas %>% kbl() %>%  kable_styling(font_size = 12)

PsR2_0 <- summary(mod0)$r.squared
PsR2_1 <- summary(mod1)$r.squared
PsR2_2 <- summary(mod2)$r.squared

```

### Medidas de Evaluación

```{r}
pred0<- predict(mod0, newdata = test[,-2])
pred1<- predict(mod1, newdata = test[,-2])
pred2<- predict(mod2,newdata = test[,-2])

## Calculando el Pseudocoeficiente de determinación.
numerador <- (test$Unidades-pred0)^2
denominador <- (test$Unidades - mean(test$Unidades))^2
PseudoR2_0 <-1 - (sum(numerador)/sum(denominador))

numerador <- (test$Unidades-pred1)^2
PseudoR2_1 <-1 - (sum(numerador)/sum(denominador))

numerador <- (test$Unidades-pred2^2)^2
PseudoR2_2 <-1 - (sum(numerador)/sum(denominador))


metricas_test <- data.frame("Modelo"=c("Modelo0","Modelo1","Modelo2"),
                      "MSE"=c(mean((test$Unidades - pred0)^2),
                              mean((test$Unidades - pred1)^2),
                              mean((test$Unidades - (pred2^2))^2)),
                      "R pseudo2"= c(PseudoR2_0,PseudoR2_1,PseudoR2_2))
metricas_test %>% kbl() %>%  kable_styling(font_size = 12)
```

### Variación Pseudo R2

Se evalua la variación entre train 2014-2016, vs test 2017

```{r}
variaR2 <- data.frame("Modelo"=c("Modelo0","Modelo1","Modelo2"),
                      "Variacion"= c(((PsR2_0-PseudoR2_0)/PsR2_0)*100,
                                     ((PsR2_1-PseudoR2_1)/PsR2_1)*100,
                                     ((PsR2_2-PseudoR2_2)/PsR2_2)*100))
variaR2 %>% kbl() %>%  kable_styling(font_size = 12)
```


```{r eval=F}
#BASE 2018
db2018<-readRDS("db_2018.rds")
# Evaluar 2018 a Entregar
pred0<- predict(mod0, newdata = db2018[,-2])
pred1<- predict(mod1, newdata = db2018[,-2])
pred2<- predict(mod2,newdata = db2018[,-2])
```

## Modelos elegidos y métricas de error ???


## Enlaces externos


Ahora bien, las bases de datos, al igual que el código desarrollado para la realización del presente trabajo se encuentran en el siguiente repositorio de GitHub [Click Aquí](https://github.com/kaamayam/RUNT_prediction)



