---
title: "Reporte Técnico RUNT"

author:
- "**Karen Andrea Amaya**"
- "**Sebastián Restrepo Betancur**"
- "**María Del Pilar Mira Londoño**"
- "**María Isabel Plata**"
date: "Enero de 2022"
output: rmdformats::robobook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```

```{r warning=F, message=F, results='hide'}
library(tidyverse)
library(kableExtra)
require(gridExtra)
library(gamlss)
library(Hmisc,warn.conflicts=F, quietly=T) #Rezagos
library(readxl)
```

## Introducción

El presente trabajo busca predecir el número de vehículos registrados a diario en el sistema de tránsito nacional RUNT a través de un modelo estadístico. El Registro Único Nacional de Tránsito (RUNT) es un sistema de información en Colombia que permite "registrar y mantener actualizada, autorizada y validada la información de todo el sector de tránsito y transporte", por lo cual es de suma importancia para el sector público y de transporte tener un pronóstico que les permita impulsar diferentes políticas o planes de acción. Para dar solución a este problema se parte de la cantidad de vehículos registrados en el RUNT desde el 1 de enero del 2012 hasta el 31 de diciembre del 2017.

## Análisis descriptivo

```{r}
datosini<-readRDS("Base_datos/BaseFinal.rds")
datos<-readRDS("Base_datos/BaseFinal.rds")
datos$Unidades<-as.integer(datos$Unidades)
datos<- datos[,c(1:7)]#quitar observance 
```

```{r}
library(readxl)
TRM<- read_excel("Base_datos/TRM.xlsx")
#add dolar variable
datos <- left_join(x = datos, y = TRM[,c("Fecha","dolar")], by="Fecha")
datos<- datos[,-1] #quitar variable Fecha
```

```{r}
#add tasas variable
tasas<-read_excel("Base_datos/Tasas_emp.xlsx") %>% as.data.frame()
colnames(tasas)<-c("Fecha","TOc","TDe")
tasas<- separate(na.omit(tasas),"Fecha", into = c("year","mes"),sep = "-")
tasas$year<-as.integer(tasas$year)
tasas$mes<- as.integer(tasas$mes)
tasas$mes<- as.factor(month.name[tasas$mes]) 
datos<-left_join(x = datos, y = tasas , by=c("year","mes"))
```

```{r}
train<- filter(datos, datos$year<=2016)
test<- filter(datos, datos$year>2016)
```

Con base en la figura 1, se puede apreciar que el año donde se registraron más vehículos fue el 2014, con aproximadamente 327957 registros. Por otro lado el año con menos registros fue el 2017 con aproximadamente 240378. Con un aparente comportamiento decreciente desde el año 2014 al 2017.


```{r out.width="60%"}
Año= c("2012","2013","2014","2015","2016","2017")
Cantidad_registros= c(311920, 295803, 327957, 284916, 254893, 240378)
db=data.frame(Año,Cantidad_registros)
gr4 <- ggplot(db, aes(x=Año, y=Cantidad_registros, fill=Año)) + geom_bar(stat="identity")+ labs(title = "Número registros por año",
       caption = "Figura 1",
       x = "# de registros",
       y = "Año",
       color = "Especie de Pingüino")+
  theme (plot.title = element_text(family="Comic Sans MS",
                                   size=rel(1.5),  
                                   vjust=2,  
                                   face="bold", 
                                   color="black", 
                                   lineheight=1.0)) + 
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_brewer(palette = "Set3")+
  theme(axis.text.x = element_blank(), axis.ticks = element_blank(),axis.title = element_blank())+
          geom_text(
    aes(label = Cantidad_registros, y = Cantidad_registros ),
    position = position_stack(vjust = 0.5))
gr4
```

Por otro lado, testizando un análisis de meses, el mes de Diciembre es aquel con una cifra significativamente más alta que los demás meses, esto puede ser debido a que los vendedores tienen un margen de ventas por cumplir, lo que hace que diciembre se convierta en un mes muy recomendado por los expertos para comprar carro y además en este mes se celebran Navidad. Por otro lado, el mes con menos registros resultó ser el mes de Enero, esto se observa en la figura 2.

```{r out.width="60%"}
MES=c("January","February","March","April","May","June","July","August","September","October","November","December")
Cantidad_registro= c(115653, 132001, 140967,137742,141168, 133853,142714,144291,146002,146319,140249,194908)
dI= data.frame(MES,Cantidad_registro)
gr1 <- ggplot(dI,aes(x=MES, y=Cantidad_registro, fill=MES)) + geom_bar(stat="identity")+ labs(title="Cantidad de registros por mes",
       caption = "Figura 2",
       x = "# de registros",
       y = "Mes")+coord_flip()+
  theme (plot.title = element_text(family="Comic Sans MS",
                                   size=rel(1.5),  
                                   vjust=2,  
                                   face="bold", 
                                   color="black", 
                                   lineheight=1.0)) + 
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_brewer(palette = "Set3")+
  theme(axis.text.x = element_blank(), axis.ticks = element_blank(),axis.title = element_blank(),legend.position="none")+
  geom_text(
    aes(label = Cantidad_registro, y = Cantidad_registro),
    position = position_stack(vjust = 0.5))
gr1
```

Resulta de interes conocer cómo varía el número de registros de acuerdo al día de la semana. Según el siguiente gráfico (Figura 3), todos los días tienen un comportamiento similar, a excepción de los días Sábado y Lunes donde hay considerablemente una cantidad menor, y el Domingo donde no se presta el servicio.

```{r out.width="60%"}
dia=c("Monday","Sunday","Saturday","Friday","Thursday","Tuesday","Wednesday")
Cantidad_vehiculos= c(208582,893,107857, 368495,361025,314588,354427)
ho=data.frame(dia,Cantidad_vehiculos)
gr0 <- ggplot(ho, aes(x=dia, y=Cantidad_vehiculos, fill=dia)) + geom_bar(stat="identity")+ labs(title = "Cantidad de registros por día",
       caption = "Figura 3",
       x = "# de registros",
       y = "Día")+
  theme (plot.title = element_text(family="Comic Sans MS",
                                   size=rel(1.5),  
                                   vjust=2,  
                                   face="bold", 
                                   color="black", 
                                   lineheight=1.0)) + 
  coord_flip()+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_brewer(palette = "Set3")+
  theme(axis.text.x = element_blank(), axis.ticks = element_blank(),axis.title = element_blank(),legend.position="none")+
  geom_text(
    aes(label = Cantidad_vehiculos, y = Cantidad_vehiculos ),
    position = position_stack(vjust = 0.5))
  
gr0


```



Ahora bien, decidimos incluir la variable precio del dólar en pesos ya que consideramos que cuando el dólar sube el peso colombiano tiende a devaluarse más y esto puede influir negativamente en la compra de autos en el país. En la figura 4 se puede ver que la correlación entre precio del dólar y Unidades es negativa aunque no es fuerte.


```{r out.width="60%", message=FALSE, warning=F}
ggplot(data = datos, aes(x = dolar, y = Unidades)) +
  geom_smooth(method = lm , se = FALSE, col="red") +
  geom_point(col="blue")+labs(title = "Gráfico dólar vs Unidades registradas",caption = "Figura 4",
       x = "Precio del dólar",
       y = "Unidades registradas")+
  theme (plot.title = element_text(family="Comic Sans MS",
                                   size=rel(1.5),  
                                   vjust=2,  
                                   face="bold", 
                                   color="black", 
                                   lineheight=1.0))+
  theme(plot.title = element_text(hjust = 0.5))
```



# Base de datos

La base de datos final está compuesta por las siguientes variables:

- **Unidades:** Cantidad de registros en en RUNT por fecha. Variable respuesta de tipo entero.
- **año:** Variable explicativa de tipo entero
- **mes:** Variable explicativa de tipo factor con 12 niveles
- **dia:** Día de tipo factor con 7 niveles
- **dia_num:** Número del día según el calendario, de tipo entero
- **holi_bin:** Variable de tipo factor con 2 niveles, 1 si es un festivo nacional y 0 en caso contrario
- **dolar:** Es la cantidad de pesos colombianos por un dólar de los Estados Unidos en las respectivas fechas.
-**TOc**: Tasa de ocupación de Colombia
-**TDe**: Tasa de desempleo de Colombia

Las dos ultimas variables las quisimos tener en nuestros modelos para predecir los registros diarios del RUNT ya que pensamos que son  significativas y aportarán  explicabilidad al modelo.


```{r}
datos%>%kbl() %>%  kable_styling(font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "300px")
```


Se dividen los datos en train con los años de 2012 a 2017 y se testiza test con los datos del primer semestre del 2018. A continuación se lista el nombre correspondiente a los festivos nacionales:  

```{r}
holid<-readRDS("Base_datos/national_holidays.rds")
data.frame("National Holidays"=unique(holid$name))%>%kbl() %>% kable_styling(font_size = 12) %>% kableExtra::scroll_box(width = "30%", height = "190px")
```

```{r}
# special<-readRDS("Base_datos/special_dates.rds")
# data.frame("Special dates"=unique(special$name)) %>% kbl() %>%  kable_styling(font_size = 12) %>% kableExtra::scroll_box(width = "30%", height = "190px")
```


```{r}
# Modelo Lineal Basico Crudo
datos <- datos[,-c(8,9)]
mod0 <- lm(Unidades ~. , data = datos)
#plot(x = datos$Unidades,mod0$fitted.values)
```

## Outliers

A continuación se puede observar un gráfico de cajas para la variable Unidades, donde se puede observar que la media del número de registros diarios se encuentra alrededor de 900, además de una cantidad de registros atípicos, con valores entre los 2500 y más de 3500 en un día. Así entonces se procede a remover dichos valores de la base de entrenamiento.


```{r out.width="40%"}
ggplot(datos, aes(y=Unidades))+
  geom_boxplot(fill='#FFCCC1',alpha=0.7)+
  labs(title = 'Gráfico de cajas para la variable Unidad',
       x = 'Unidades', y='Número de registros diarios RUNT',
       color=NULL,
       caption = "Figura 5")+
  theme (plot.title = element_text(family="Comic Sans MS",
                                   size=rel(1.5),  
                                   vjust=2,  
                                   face="bold", 
                                   color="black", 
                                   lineheight=1.0))+
  theme(plot.title = element_text(hjust = 0.5))
#TRAIN & TEST
p70 <- quantile(x = datos$Unidades,probs = .7)
datos2 <- datos[datos$Unidades<p70,]
#train<- filter(datos2, datos2$year<=2016)
```

# Modelos


```{r out.width="70%"}
# Modelo Lineal Sin Outliers
mod1 <- lm(Unidades ~. , data = train)


## Modelo Raiz Sin Outliers
mod2 <- lm(sqrt(Unidades) ~. , data = train)

par(mfrow=c(1,2))
a=mod1$fitted.values

tabla=data.frame(train$Unidades,a )
ggplot(tabla, aes(x=train$Unidades, y=a))+
  geom_point(shape=1, col="purple") +
  labs(title = "Modelo Lineal Sin Outliers", caption = "Figura 6",x = "Unidades", y = "Valores predichos") +
  geom_smooth(method=lm , color="red", se=TRUE)+
  theme (plot.title = element_text(family="Comic Sans MS",
                                   size=rel(1.5),  
                                   vjust=2,  
                                   face="bold", 
                                   color="black", 
                                   lineheight=1.0))+
  theme(plot.title = element_text(hjust = 0.5))

b=(mod2$fitted.values)^2 
tabla=data.frame(train$Unidades,b )
ggplot(tabla, aes(x=train$Unidades, y=b))+
  geom_point(shape=1, col="orange") +
  labs(title = "Modelo Raíz Sin Outliers", caption = "Figura 7",x = "Unidades", y = "Valores predichos") +
  geom_smooth(method=lm , color="red", se=TRUE)+
  theme (plot.title = element_text(family="Comic Sans MS",
                                   size=rel(1.5),  
                                   vjust=2,  
                                   face="bold", 
                                   color="black", 
                                   lineheight=1.0))+
  theme(plot.title = element_text(hjust = 0.5))
#saveRDS(mod2, "Modelo.rds")
```
### Modelo árbol de decisón
```{r out.width="70%"}
#arbol
library(rpart)
library(rpart.plot)
mod3 <- rpart(formula = Unidades ~ .,data = train,method = "anova")
rpart.plot(mod3)
```


# Comparacion de modelos

Se hace uso de las siguientes medidas para comparar diferentes modelos:

$$
A I C=2 k-2 \ln (L);\quad \quad  R_{p s e u d o}^{2}=1-\frac{\sum_{i=1}^{n}\left(y_{i}-\hat{y}_{i}\right)^{2}}{\sum_{i=1}^{n}\left(y_{i}-\bar{y}\right)^{2}}; \quad \quad \text { MSE }=\frac{1}{n} \sum\left(y_{n}-\overline{\mathrm{y}}\right)^{2}
$$


## Medidas de Entrenamiento

```{r}
#Pseudos R2
PsR2_0 <- summary(mod0)$r.squared
PsR2_1 <- summary(mod1)$r.squared
PsR2_2 <- summary(mod2)$r.squared
# Pseudo R2 para el arbol
pred<- predict(mod3,newdata = train[,-1])
numerador <- (train$Unidades-pred)^2
denominador <- (train$Unidades - mean(train$Unidades))^2
PsR2_3 <- 1 - (sum(numerador)/sum(denominador))

metricas<- data.frame("Modelo"=c("Modelo0","Modelo1","Modelo2","Modelo3"),
                      "MSE"=c(mean(mod0$residuals^2),
                              mean(mod1$residuals^2),
                              mean((train$Unidades - fitted(mod2)^2)^2),
                              mean((train$Unidades - pred)^2) ),
                      "R pseudo2"= c(PsR2_0, 
                                     PsR2_1, 
                                     PsR2_2, 
                                     PsR2_3),
                      "AIC"=c(AIC(mod0),
                              AIC(mod1),
                              AIC(mod2),
                              "NA"))
metricas %>% kbl() %>%  kable_styling(font_size = 12)

```

## Medidas de Evaluación


```{r}
#-------------------------------------------------------------------
#-------------------------Test--------------------------
#-------------------------------------------------------------------
```

```{r}
pred0<- predict(mod0, newdata = test[,-1])
pred1<- predict(mod1, newdata = test[,-1])
pred2<- predict(mod2,newdata = test[,-1])
pred3<- predict(mod3,newdata = test[,-1])

## Calculando el Pseudocoeficiente de determinación.
numerador <- (test$Unidades-pred0)^2
denominador <- (test$Unidades - mean(test$Unidades))^2
PseudoR2_0 <-1 - (sum(numerador)/sum(denominador))

numerador <- (test$Unidades-pred1)^2
PseudoR2_1 <-1 - (sum(numerador)/sum(denominador))

numerador <- (test$Unidades-pred2^2)^2
PseudoR2_2 <-1 - (sum(numerador)/sum(denominador))

## Psseudo R2 arbol
numerador <- (test$Unidades-pred3)^2
denominador <- (test$Unidades - mean(test$Unidades))^2
PseudoR2_3 <-1 - (sum(numerador)/sum(denominador))

```

```{r}
metricas_test <- data.frame("Modelo"=c("Modelo0","Modelo1","Modelo2","Modelo3"),
                      "MSE"=c(mean((test$Unidades - pred0)^2),
                              mean((test$Unidades - pred1)^2),
                              mean((test$Unidades - (pred2^2))^2),
                              mean((test$Unidades - pred3)^2)),
                      "R pseudo2"= c(PseudoR2_0,PseudoR2_1,PseudoR2_2,                                           PseudoR2_3))
metricas_test %>% kbl() %>%  kable_styling(font_size = 12)
```

## Variación Pseudo R2

Se evalua la variación entre train 2012-2016, vs test 2017

```{r}
variaR2 <- data.frame("Modelo"=c("Modelo0","Modelo1","Modelo2","Modelo 3"),
                      "Tipo"=c("Lineal","Lineal no Out","Trans.Raiz",
                               "Arboles"),
                      "Variacion R2"= c(((PsR2_0-PseudoR2_0)/PsR2_0)*100,
                                     ((PsR2_1-PseudoR2_1)/PsR2_1)*100,
                                     ((PsR2_2-PseudoR2_2)/PsR2_2)*100,
                                     ((PsR2_3-PseudoR2_3)/PsR2_3)*100) )
variaR2 %>% kbl() %>%  kable_styling(font_size = 12)
```

# Modelos elegidos

Los modelos elegidos fueron: Modelo 1 con lineal, Modelo 3 con árboles de regresión, esto a partir de las medias de entrenamiento y al ver que la variación entre el R2 de train t test era menor en estos dos modelos. Así entonces, se vuelven a correr los modelos finales, con todos los datos desde el año 2012 hasta el año 2017 para realizar las predicciones al primer semestre del año 2018.

```{r}
#arbol con todos los datos
library(rpart)
mod_Final <- rpart(formula = Unidades ~ .,data = datos,method = "anova")
mod_Final2 <- lm(Unidades ~. , data = datos)
```


## Metricas de entrenamiento de los modelos escogidos (2012-2017)

```{r}
#Pseudos R2 para modelo1 (lineal)

PsR2_4 <- summary(mod_Final2)$r.squared
# Pseudo R2 para el arbol
predr<- predict(mod_Final,newdata = datos[,-1])
numerador <- (datos$Unidades-predr)^2
denominador <- (datos$Unidades - mean(datos$Unidades))^2
PsR2_3 <- 1 - (sum(numerador)/sum(denominador))


metricastrain<- data.frame("Modelo"=c("Modelo1","Modelo3"),
                      "MSE"=c(mean(mod_Final2$residuals^2),
                              mean((datos$Unidades - predr)^2)),
                      "R pseudo2"= c(PsR2_4, 
                                     PsR2_3))
metricastrain %>% kbl() %>%  kable_styling(font_size = 12)

```

```{r}
pred_train1<- predict(mod_Final,newdata = datos[,-1]) %>% as.data.frame()
pred_train2<- predict(mod_Final2,newdata = datos[,-1])%>% as.data.frame()
```



```{r eval=F}
library("writexl")
write_xlsx(pred_train1, "Plano_train_1.xlsx")
write_xlsx(pred_train2, "Plano_train_2.xlsx")
```

## Primer archivo plano 
Las siguientes son las predicciones resultantes para 2012-2017, realizadas por el modelo lineal y con árboles de regresión respectivamente:

```{r}

pred2<- predict(mod_Final,newdata = datos)
datosini$Fecha <- as.factor(datosini$Fecha)
pred2<- cbind.data.frame("Fecha"=datosini$Fecha,"Predicción" =pred2 )
pred2 %>%kbl() %>%  kable_styling(font_size = 12)%>% kableExtra::scroll_box(width = "30%", height = "190px") ## Modelo lineal


pred3<- predict(mod_Final2,newdata = datos)
pred3<- cbind.data.frame("Fecha"=datosini$Fecha,"Predicción" =pred3 )
pred3 %>%kbl() %>%  kable_styling(font_size = 12)%>% kableExtra::scroll_box(width = "30%", height = "190px")## modelo arbol


```




## Base de datos 2018 (para entregar)

Las siguientes son las predicciones resultantes para el primer semestre del año 2018, realizadas por el modelo lineal y con árboles de regresión respectivamente:

```{r}
#BASE 2018
db2018<-readRDS("Base_datos/db_2018.rds")
db2018<- filter(db2018, Fecha <= "2018-06-30")
db2018 <- left_join(x = db2018, y = TRM[,c("Fecha","dolar")], by="Fecha")
db2018<-left_join(x = db2018, y = tasas , by=c("year","mes"))


```


## Segundo Archivo plano

Las siguientes son las predicciones resultantes para el primer semestre del año 2018, realizadas por el modelo lineal y con árboles de regresión respectivamente:

```{r eval=F}
library("writexl")
write_xlsx(pred3, "Plano1_2018.xlsx")
```


```{r}
pred4<- predict(mod_Final,newdata = db2018[,-1])
db2018$Fecha <- as.factor(db2018$Fecha)
pred4<- cbind.data.frame("Fecha"=db2018$Fecha,"Predicción" =pred4 )
pred4 %>%kbl() %>%  kable_styling(font_size = 12)%>% kableExtra::scroll_box(width = "30%", height = "190px") ## Modelo lineal


predl<- predict(mod_Final2,newdata = db2018[,-1])
predl<- cbind.data.frame("Fecha"=db2018$Fecha,"Predicción" =predl )
predl %>%kbl() %>%  kable_styling(font_size = 12)%>% kableExtra::scroll_box(width = "30%", height = "190px")## Modelo arbol


```
```{r eval=F}
library("writexl")
write_xlsx(predl, "Plano2_2018.xlsx")


```


# Enlaces externos

Ahora bien, las bases de datos, al igual que el código desarrollado para la testización del presente trabajo se encuentran en el siguiente repositorio de GitHub [Click Aquí](https://github.com/kaamayam/RUNT_prediction)

# Referencias

- Banco de la República, Tasa Representativa del Mercado (TRM - Peso por dólar). Banrep. Recuperado 7 de enero de 2022, de https://www.banrep.gov.co/es/estadisticas/trm

- DANE. Tasas de ocupación y desempleo. Banco de la república | Colombia.  Recuperado 16 de enero de 2022, de https://www.banrep.gov.co/es/estadisticas/tasas-ocupacion-y-desempleo

- Holidays and observances in Colombia. (1995). Time and Date. Recuperado 17 de diciembre de 2021, de https://www.timeanddate.com/holidays/colombia/2012

